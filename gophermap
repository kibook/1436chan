#!/bin/bash

cd "${0%/*}"

source params.sh

if [[ "$@" == "catalog" ]]
then
	LAST_POSTS=0
fi

if [[ -e "motd" ]]
then
	cat motd | ./gophermaputil
	printf "i	fake	(NULL)	0\r\n"
fi

for sticky in $(ls -td sticky_* 2>/dev/null)
do
	printf "1[sticky] $(cat $sticky/gophertag)	$CHAN_ROOT/$sticky	$SERVER_HOST	$SERVER_PORT\r\n"
done

if [[ $(ls sticky_* 2>/dev/null | wc -l) -gt 0 ]]
then
	printf "i	fake	(NULL)	0\r\n"
fi

printf "7New thread	$CHAN_ROOT/newthread	$SERVER_HOST	$SERVER_PORT\r\n"
printf "i	fake	(NULL)	0\r\n"

pad=$(printf "_%.0s" {1..70})

for thread in $(ls -td [0-9]* 2>/dev/null)
do
	cd $thread

	threadstamp="${thread%_*}"
	threadno="${thread#*_}"

	if [[ ! -e archive ]]
	then
		lastposts=$(ls -v [0-9]* 2>/dev/null | tail -n $LAST_POSTS)
		npost=$(ls [0-9]* 2> /dev/null | wc -l)
		nlast=$(echo -n "$lastposts" | wc -l)

		if [[ $npost -gt 0 || "$SHOW_EMPTY_THREADS" = "y" ]]
		then
			printf "1[##%d] %s (%d " $threadno "$(cat gophertag)" $npost
			if [ $npost -eq 1 ]
			then
				printf "post"
			else
				printf "posts"
			fi
			printf ")\t$CHAN_ROOT/$thread\t$SERVER_HOST\t$SERVER_PORT\r\n"

			i=$((npost-nlast))
			for post in $lastposts
			do
				stamp="${post%_*}"
				no="${post#*_}"
				posted=$(date -d @$stamp +"$DATE_FORMAT")

				header=$(printf "__[%s #%d]%s" "$posted" $no "$pad" | cut -c1-69)
				printf "i$header	fake	(NULL)	0\r\n"

				saveifs="$IFS"
				IFS=''
				while read line
				do
					if echo "$line" | grep -q "	"
					then
						printf "%s\r\n" "$line"
					else
						while read fmtline
						do
							printf "i%s	fake	(NULL)	0\r\n" "$fmtline"
						done < <(echo "$line" | fmt -69)
					fi
				done < $post
				IFS="$saveifs"

				printf "i	fake	(NULL)	0\r\n"

				i=$((i+1))
			done

			if [[ $LAST_POSTS -gt 0 && $nlast -gt 0 ]]
			then
				printf "i	fake	(NULL)	0\r\n"
			fi
		fi
	fi

	cd ..
done

if [[ "$ENABLE_ARCHIVE" == "y" ]]
then
	printf "i	fake	(NULL)	0\r\n"
	printf "1Archive	$CHAN_ROOT/archive	$SERVER_HOST	$SERVER_PORT\r\n"
fi
